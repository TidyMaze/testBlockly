<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="blockly/blockly_compressed.js"></script>
    <script src="blockly/javascript_compressed.js"></script>
    <script src="blockly/blocks_compressed.js"></script>
    <script src="blockly/msg/js/en.js"></script>
</head>
<body>
    <div id="blocklyDiv" style="height: 480px; width: 1000px;"></div>
    <button onclick="showCode()">Show JavaScript</button>
    <button onclick="runCode()">Run JavaScript</button>

    <xml id="toolbox" style="display: none">
        <category name="Logic">
            <category name="If">
                <block type="controls_if"></block>
                <block type="controls_if">
                    <mutation else="1"></mutation>
                </block>
                <block type="controls_if">
                    <mutation elseif="1" else="1"></mutation>
                </block>
            </category>
            <category name="Boolean">
                <block type="logic_compare"></block>
                <block type="logic_operation"></block>
                <block type="logic_negate"></block>
                <block type="logic_boolean"></block>
                <block type="logic_null"></block>
                <block type="logic_ternary"></block>
            </category>
        </category>
        <category name="Loops">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <block type="math_number">
                        <field name="NUM">10</field>
                    </block>
                </value>
            </block>
            <block type="controls_whileUntil"></block>
            <block type="controls_for">
                <field name="VAR">i</field>
                <value name="FROM">
                    <block type="math_number">
                        <field name="NUM">1</field>
                    </block>
                </value>
                <value name="TO">
                    <block type="math_number">
                        <field name="NUM">10</field>
                    </block>
                </value>
                <value name="BY">
                    <block type="math_number">
                        <field name="NUM">1</field>
                    </block>
                </value>
            </block>
            <block type="controls_forEach"></block>
            <block type="controls_flow_statements"></block>
        </category>
        <category name="string">
            <block type="text_print"></block>
            <block type="text"></block>
        </category>
        <category name="Math">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
            <block type="math_single"></block>
            <block type="math_trig"></block>
            <block type="math_constant"></block>
            <block type="math_number_property"></block>
            <block type="math_foo"></block>
            <block type="math_change">
                <value name="DELTA">
                    <block type="math_number">
                        <field name="NUM">1</field>
                    </block>
                </value>
            </block>
            <block type="math_round"></block>
            <block type="math_on_list"></block>
            <block type="math_modulo"></block>
            <block type="math_constrain">
                <value name="LOW">
                    <block type="math_number">
                        <field name="NUM">1</field>
                    </block>
                </value>
                <value name="HIGH">
                    <block type="math_number">
                        <field name="NUM">100</field>
                    </block>
                </value>
            </block>
            <block type="math_random_int">
                <value name="FROM">
                    <block type="math_number">
                        <field name="NUM">1</field>
                    </block>
                </value>
                <value name="TO">
                    <block type="math_number">
                        <field name="NUM">100</field>
                    </block>
                </value>
            </block>
            <block type="math_random_float"></block>
        </category>
        <category name="Lists">
            <block type="lists_create_empty"></block>
            <block type="lists_create_with"></block>
            <block type="lists_repeat">
                <value name="NUM">
                    <block type="math_number">
                        <field name="NUM">5</field>
                    </block>
                </value>
            </block>
            <block type="lists_length"></block>
            <block type="lists_isEmpty"></block>
            <block type="lists_indexOf"></block>
            <block type="lists_getIndex"></block>
            <block type="lists_setIndex"></block>
        </category>
        <category name="Variables" custom="VARIABLE"></category>
        <category name="Functions" custom="PROCEDURE"></category>
        <category name="Events">
            <block type="addevent"></block>
        </category>
        <category name="Actions">
            <block type="blink"></block>
            <block type="playaudio"></block>
        </category>
        <category name="Conditions">
            <block type="distancetag"></block>
            <block type="poivisible"></block>
        </category>
    </xml>

    <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>

    <script>
        function addQuotes(str){
            return '\''+str+'\'';
        }

        var workspace = Blockly.inject('blocklyDiv',
                {toolbox: document.getElementById('toolbox')});

        var poiMap = [
            ["masque", "0001"],
            ["statue", "0002"],
            ["tableau", "0003"]
        ];

        var tagMap = [
            ["tagMasque", "6344159173"],
            ["tagStatue", "6344159174"],
            ["tagTableau", "6344159175"],
        ];

        Blockly.Blocks['math_foo'] = {
            init: function() {
                this.appendValueInput("NAME")
                        .setCheck("Number")
                        .appendField("Nombre1");
                this.appendValueInput("NAME2")
                        .setCheck("Number")
                        .appendField("Nombre2");
                this.setOutput(true, "Number");
                this.setColour(20);
                this.setTooltip('');
                this.setHelpUrl('http://www.example.com/');
            }
        };

        Blockly.JavaScript['math_foo'] = function(block) {
            var value_name = Blockly.JavaScript.valueToCode(block, 'NAME', Blockly.JavaScript.ORDER_ATOMIC);
            var value_name2 = Blockly.JavaScript.valueToCode(block, 'NAME2', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = value_name + " + " + value_name2;
            // TODO: Change ORDER_NONE to the correct strength.
            return [code, Blockly.JavaScript.ORDER_NONE];
        };

        Blockly.Blocks['blink'] = {
            init: function() {
                this.appendDummyInput()
                        .appendField("pidPOI")
                        .appendField(new Blockly.FieldDropdown(poiMap), "pidPOI");
                this.appendDummyInput()
                        .appendField("active")
                        .appendField(new Blockly.FieldCheckbox("TRUE"), "blinkOrNot");
                this.setInputsInline(true);
                this.setOutput(true);
                this.setColour(225);
                this.setTooltip('');
                this.setHelpUrl('http://www.example.com/');
            }
        };

        Blockly.JavaScript['blink'] = function(block) {
            var value_pid = Blockly.JavaScript.valueToCode(block, 'pid', Blockly.JavaScript.ORDER_ATOMIC);
            var value_blinkornot = Blockly.JavaScript.valueToCode(block, 'blinkOrNot', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = 'ACTION_POI_MAP_BLINK('+value_pid+','+value_blinkornot+')';
            return code;
        };


        Blockly.Blocks['playaudio'] = {
            init: function() {
                this.appendDummyInput()
                        .appendField("pidPOI")
                        .appendField(new Blockly.FieldDropdown(poiMap), "pidPOI");
                this.appendValueInput("audioId")
                        .setCheck("String")
                        .appendField("audioId");
                this.appendValueInput("volume")
                        .setCheck("Number")
                        .appendField("volume");
                this.appendDummyInput()
                        .appendField("loop")
                        .appendField(new Blockly.FieldCheckbox("TRUE"), "loop");
                this.setInputsInline(true);
                this.setOutput(true);
                this.setColour(20);
                this.setTooltip('');
                this.setHelpUrl('http://www.example.com/');
            }
        };

        Blockly.JavaScript['playaudio'] = function(block) {
            var value_pidPOI = block.getFieldValue('pidPOI');
            var value_audioId = Blockly.JavaScript.valueToCode(block, 'audioId', Blockly.JavaScript.ORDER_ATOMIC);
            var value_volume = Blockly.JavaScript.valueToCode(block, 'volume', Blockly.JavaScript.ORDER_ATOMIC);
            var value_loop = block.getFieldValue('loop') == 'TRUE';
            // TODO: Assemble JavaScript into code variable.
            var code = 'ACTION_PLAY_AUDIO({poi:'+value_pidPOI+", usage:"+value_audioId+", volume:"+value_volume+", loop:"+value_loop+'})';
            // TODO: Change ORDER_NONE to the correct strength.
            return [code, Blockly.JavaScript.ORDER_NONE];
        };

        Blockly.Blocks['addevent'] = {
            init: function() {
                this.appendValueInput("nomEvent")
                        .setCheck("String")
                        .appendField("nom");
                this.appendDummyInput()
                        .appendField(new Blockly.FieldDropdown([["Enter", "ENTER"], ["Exit", "EXIT"]]), "way");
                this.appendValueInput("conditions")
                        .setCheck("Array")
                        .appendField("conditions");
                this.appendValueInput("actions")
                        .setCheck("Array")
                        .appendField("actions");
                this.setInputsInline(false);
                this.setColour(65);
                this.setTooltip('');
                this.setHelpUrl('http://www.example.com/');
            }
        };

        Blockly.JavaScript['addevent'] = function(block) {
            var value_nomevent = Blockly.JavaScript.valueToCode(block, 'nomEvent', Blockly.JavaScript.ORDER_ATOMIC);
            var dropdown_way = block.getFieldValue('way');
            var value_conditions = Blockly.JavaScript.valueToCode(block, 'conditions', Blockly.JavaScript.ORDER_ATOMIC);
            var value_actions = Blockly.JavaScript.valueToCode(block, 'actions', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = value_nomevent + ' ' + dropdown_way + ' ' + value_conditions + ' ' + value_actions;
            return code;
        };

        Blockly.Blocks['distancetag'] = {
            init: function() {
                this.appendDummyInput()
                        .appendField("distance de")
                        .appendField(new Blockly.FieldDropdown(tagMap), "pidPOI");
                this.setInputsInline(true);
                this.setOutput(true, "Number");
                this.setColour(210);
                this.setTooltip('');
                this.setHelpUrl('http://www.example.com/');
            }
        };

        Blockly.JavaScript['distancetag'] = function(block) {
            var dropdown_pidpoi = block.getFieldValue('pidPOI');
            // TODO: Assemble JavaScript into code variable.
            var code = 'DISTANCE_TAG('+JSON.stringify(dropdown_pidpoi)+')';
            // TODO: Change ORDER_NONE to the correct strength.
            return [code, Blockly.JavaScript.ORDER_NONE];
        };

        Blockly.Blocks['poivisible'] = {
            init: function() {
                this.appendDummyInput()
                        .appendField(new Blockly.FieldDropdown(poiMap), "pidPOI")
                        .appendField("visible");
                this.setInputsInline(true);
                this.setOutput(true, "Boolean");
                this.setColour(210);
                this.setTooltip('');
                this.setHelpUrl('http://www.example.com/');
            }
        };

        Blockly.JavaScript['poivisible'] = function(block) {
            var dropdown_pidpoi = block.getFieldValue('pidPOI');
            // TODO: Assemble JavaScript into code variable.
            var code = 'POI_MAP_VISIBLE('+dropdown_pidpoi+')';
            // TODO: Change ORDER_NONE to the correct strength.
            return [code, Blockly.JavaScript.ORDER_NONE];
        };

        function showCode() {
            // Generate JavaScript code and display it.
            Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            alert(code);
        }

        function runCode() {
            // Generate JavaScript code and run it.
            window.LoopTrap = 1000;
            Blockly.JavaScript.INFINITE_LOOP_TRAP =
                    'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
            try {
                eval(code);
            } catch (e) {
                alert(e);
            }
        }

        /** * backup code blocks */
        function backup_blocks() {
            if(typeof(Storage)!=="undefined") {
                var xml = Blockly.Xml.workspaceToDom( Blockly.mainWorkspace );
                localStorage.setItem('data',Blockly.Xml.domToText( xml ));
                console.log("backuped");
            } else { // Sorry! No web storage support.. } }

            }
        }

        /** * restore code blocks */
        function restore_blocks() {
            if(typeof(Storage)!=="undefined"){
                if(localStorage.data!=null){
                    var xml = Blockly.Xml.textToDom(localStorage.data);
                    Blockly.Xml.domToWorkspace( Blockly.mainWorkspace, xml );
                    console.log("restored");
                }
            } else {
                // Sorry! No web storage support..
            }
        }

        $(window).ready(restore_blocks);
        $(window).unload(backup_blocks);

    </script>
</body>
</html>